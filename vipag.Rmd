

# Análisis de Éxito/Fracaso Académico

## Definición de Éxito Académico
```{r setup-pag3, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  warning = FALSE, 
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  dpi = 300
)

# Paquetes necesarios para el análisis
suppressPackageStartupMessages({
  library(tidyverse)    # Manipulación de datos y visualización
  library(GGally)       # Matrices de correlación y gráficos paired
  library(scales)       # Escalas para gráficos
  library(knitr)        # Tablas formateadas
  library(DT)           # Tablas interactivas
})

# Configuración del theme y paleta de colores
theme_set(theme_minimal(base_size = 12))
pal <- c("Math" = "#2B8CBE", "Portuguese" = "#E34A33")

# Carga de los datasets originales
mat <- read.delim("student-mat.csv", sep = ";")
por <- read.delim("student-por.csv", sep = ";")

# Estandarización de nombres de columnas
names(mat) <- tolower(gsub("\\.", "_", names(mat)))
names(por) <- tolower(gsub("\\.", "_", names(por)))

# Definición de tipos de variables
factor_vars_base  <- c("school","sex","address","famsize","pstatus","mjob","fjob","reason",
                       "guardian","schoolsup","famsup","paid","activities","nursery",
                       "higher","internet","romantic")

numeric_vars_base <- c("age","medu","fedu","traveltime","studytime","failures",
                       "famrel","freetime","goout","dalc","walc","health",
                       "absences","g1","g2","g3")

# Conversión de tipos de datos
mat[intersect(factor_vars_base,  names(mat))] <- 
  lapply(mat[intersect(factor_vars_base,  names(mat))], factor)
por[intersect(factor_vars_base,  names(por))] <- 
  lapply(por[intersect(factor_vars_base,  names(por))], factor)

mat[intersect(numeric_vars_base, names(mat))] <- 
  lapply(mat[intersect(numeric_vars_base, names(mat))], as.numeric)
por[intersect(numeric_vars_base, names(por))] <- 
  lapply(por[intersect(numeric_vars_base, names(por))], as.numeric)

# Eliminación de duplicados y variables no utilizadas
mat <- mat %>% distinct() %>% select(-any_of(c("famsize","nursery")))
por <- por %>% distinct() %>% select(-any_of(c("famsize","nursery")))

# Combinación de datasets con etiqueta de materia
mat$subject <- "Math"
por$subject <- "Portuguese" 
df_all <- bind_rows(mat, por) %>% relocate(subject)

# Actualización de listas de variables
factor_vars  <- intersect(factor_vars_base,  names(df_all))
numeric_vars <- intersect(numeric_vars_base, names(df_all))





# Resumen dimensional
cat("Dimensiones del dataset combinado:", dim(df_all)[1], "observaciones,", dim(df_all)[2], "variables\n")
cat("Matemáticas:", nrow(mat), "estudiantes\n")
cat("Portugués:", nrow(por), "estudiantes\n")

# Estructura de variables
cat("\n=== ESTRUCTURA DE VARIABLES ===\n")
cat("Variables categóricas (", length(factor_vars), "):", paste(factor_vars, collapse = ", "), "\n")
cat("Variables numéricas (", length(numeric_vars), "):", paste(numeric_vars, collapse = ", "), "\n")

# Creación de variable binaria (aprobado/reprobado)
df_bin <- df_all %>%
  mutate(
    status = factor(
      if_else(g3 >= 10, "Aprobado", "Reprobado"),
      levels = c("Reprobado", "Aprobado")
    )
  )

# Estadísticas de aprobación
pass_stats <- df_bin %>%
  group_by(subject) %>%
  summarise(
    total = n(),
    aprobados = sum(status == "Aprobado"),
    tasa_aprobacion = mean(status == "Aprobado") * 100,
    .groups = "drop"
  )

kable(pass_stats,
      caption = "Tasas de aprobación por materia",
      digits = 1,
      col.names = c("Materia", "Total", "Aprobados", "Tasa Aprobación (%)"))

cats_key <- intersect(c("sex","address","schoolsup","higher","internet"), names(df_all))

cat_stats <- purrr::map_dfr(cats_key, function(var){
  df_all %>%
    group_by(subject, !!sym(var)) %>%
    summarise(
      n = n(),
      mean_g3 = mean(g3),
      sd_g3 = sd(g3),
      .groups = "drop"
    ) %>%
    mutate(
      variable = var,
      category = as.character(!!sym(var))
    ) %>%
    # nos quedamos solo con las 6 columnas que queremos
    select(subject, variable, category, n, mean_g3, sd_g3)
})

knitr::kable(
  head(cat_stats, 10),
  caption = "Estadísticas de G3 por categorías (primeras 10 filas)",
  digits = 2,
  col.names = c("Materia", "Variable", "Categoría", "N", "Media G3", "SD G3")
)

nums_key <- intersect(c("g3","g2","g1","studytime","failures","absences","age"), names(df_all))
vars_panel <- unique(c(nums_key, intersect("sex", names(df_all))))
df_small <- df_all[, unique(c(vars_panel, "subject"))]

# Panel multivariado con GGally
p_mix <- ggpairs(
  df_small,
  mapping = ggplot2::aes(color = subject, alpha = 0.55),
  upper = list(
    continuous = wrap("cor", size = 3),    # Correlaciones en triángulo superior
    combo      = "box_no_facet",           # Boxplots para cat~num
    discrete   = "blank"                   # Espacio en blanco para cat~cat
  ),
  lower = list(
    continuous = wrap("points", alpha = .35, size = .6),  # Scatter plots
    combo      = "facethist",              # Histogramas por facetas
    discrete   = "count"                   # Conteos para cat~cat
  ),
  diag  = list(continuous = "densityDiag"), # Densidades en diagonal
  title = "Exploración compacta — Variables clave (coloreado por asignatura)"
) + theme(legend.position = "bottom")

print(p_mix)


```

### Factores Asociados al Éxito

```{r success-factors, fig.height=10, fig.cap="Factores asociados al éxito académico"}
# Análisis de proporciones de éxito por categorías
success_plots <- map(cats_key, ~{
  ggplot(df_bin, aes(.data[[.x]], fill = status)) +
    geom_bar(position = "fill") +
    facet_wrap(~subject) +
    scale_fill_manual(values = c("Reprobado" = "#D9D9D9", "Aprobado" = "#31A354")) +
    scale_y_continuous(labels = percent) +
    labs(title = paste("Proporción de aprobados por", .x), 
         x = .x, y = "Proporción") +
    theme(legend.position = "bottom")
})

do.call(gridExtra::grid.arrange, c(success_plots[1:4], ncol = 2))
```

```{r numeric-success, fig.height=8, fig.cap="Distribución de variables numéricas por estado académico"}
# Análisis de variables numéricas por estado
nums_success <- setdiff(nums_key, "g3")[1:4]  # Top 4 variables

numeric_success_plots <- map(nums_success, ~{
  ggplot(df_bin, aes(status, .data[[.x]], fill = status)) +
    geom_boxplot(outlier.alpha = .25, width = .5) +
    facet_wrap(~subject, scales = "free_y") +
    scale_fill_manual(values = c("Reprobado" = "#FDD0A2", "Aprobado" = "#9ECAE1")) +
    guides(fill = "none") +
    labs(title = paste(.x, "por estado académico"), x = NULL, y = .x)
})

do.call(gridExtra::grid.arrange, c(numeric_success_plots, ncol = 2))
```

**Factores Críticos de Éxito Identificados:**

1. **Aspiraciones Educativas:** Los estudiantes que planean continuar con educación superior tienen tasas de aprobación `r round(mean(df_bin$status[df_bin$higher == "yes"] == "Aprobado") * 100, 1)`% vs `r round(mean(df_bin$status[df_bin$higher == "no"] == "Aprobado") * 100, 1)`% de quienes no planean hacerlo.

2. **Historial Académico:** Los estudiantes sin reprobaciones previas muestran tasas de éxito significativamente superiores.

3. **Acceso a Recursos:** El acceso a internet y apoyo educativo se correlaciona positivamente con el éxito académico.

---
